# 進出場標記功能修正說明

## 問題描述

1. **出場時間顯示為 None**：註記中顯示有進出場時間，但圖表調試信息顯示出場時間為 None
2. **重複顯示進場資料**：一筆訂單的進場信息出現多次
3. **AttributeError**：`'str' object has no attribute 'strftime'` 錯誤

## 根本原因

### 問題 1：缺少時間欄位
評分記錄（`quality_scores.json`）中沒有保存 `open_time` 和 `close_time` 欄位，只保存了 `date`。

### 問題 2：重複顯示調試信息
調試信息在多個地方重複顯示，造成視覺混亂。

### 問題 3：類型錯誤
`trade['open_time']` 可能已經是字符串格式，不能再調用 `strftime()` 方法。

## 修正方案

### 1. 添加時間欄位到評分記錄

使用 `str()` 轉換，兼容字符串和 datetime 對象：

```python
score_record = {
    # ... 其他欄位
    'open_time': str(trade['open_time']) if pd.notna(trade.get('open_time')) else None,
    'close_time': str(trade['close_time']) if pd.notna(trade.get('close_time')) else None,
    'entry_price': float(trade.get('entry_price', 0)),
    'exit_price': float(trade.get('exit_price', 0)),
    # ... 其他欄位
}
```

### 2. 優化調試信息顯示

只在時區選擇器上方顯示一次：
```
🔍 進場時間：2026-02-04 00:57:48 | 出場時間：2026-02-04 01:43:09
```

## 使用說明

### 對於新評分的交易
從現在開始，所有新評分的交易（自動或手動）都會包含完整的時間信息：
- ✅ 進場時間（精確到秒）
- ✅ 出場時間（精確到秒）
- ✅ 進場價格
- ✅ 出場價格

### 對於已評分的交易
已經評分的交易記錄中沒有這些欄位，需要：

**選項 1：重新評分**（推薦）
1. 使用「🗑️ 清除全部評分」按鈕清除舊評分
2. 重新執行自動評分
3. 新的評分記錄會包含完整時間信息

**選項 2：手動添加**
編輯 `data/review_history/quality_scores.json`，為每筆記錄添加：
```json
{
  "trade_id": "xxx",
  "open_time": "2026-02-04 00:57:48",
  "close_time": "2026-02-04 01:43:09",
  "entry_price": 123.45,
  "exit_price": 125.67,
  // ... 其他欄位
}
```

## 驗證方法

1. **檢查調試信息**：
   - 打開交易詳情
   - 切換到「🔬 市場分析」標籤
   - 查看時區選擇器上方的信息
   - 應該顯示：`🔍 進場時間：2026-02-04 00:57:48 | 出場時間：2026-02-04 01:43:09`

2. **檢查圖表標記**：
   - 選擇任意時區（15m、1h、4h、1d）
   - K線圖上應該顯示：
     - 🟢/🔴 進場標記（三角形）
     - 🟡/🔴 出場標記（X符號）
     - 虛線連接進出場點

3. **檢查評分記錄**：
   - 打開 `data/review_history/quality_scores.json`
   - 檢查最新的評分記錄
   - 應該包含 `open_time`、`close_time`、`entry_price`、`exit_price` 欄位

## 注意事項

1. **時區一致性**：所有時間都使用 UTC+8（與 BingX 數據一致）
2. **數據格式**：時間格式為 `YYYY-MM-DD HH:MM:SS`
3. **向後兼容**：代碼會嘗試從多個欄位獲取時間（`open_time` → `entry_time` → `date`）
4. **錯誤處理**：如果時間解析失敗，會顯示警告信息但不會中斷程序

## 更新日期

2026-02-06
