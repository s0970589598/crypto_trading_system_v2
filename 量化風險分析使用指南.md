# 量化風險分析使用指南

## 🎯 工具簡介

`quantitative_risk_analysis.py` 是一個專業的量化風險分析工具，扮演「高頻交易量化風險官」的角色，執行嚴格的數學運算和交易數據審計。

---

## 🚀 快速開始

### 1. 運行分析

```bash
python3 quantitative_risk_analysis.py
```

### 2. 查看報告

報告會直接輸出到終端，包含三大核心分析：
1. 連損與破產風險計算
2. 手續費壓力測試
3. 傾斜 (Tilt) 檢測

---

## 📊 分析內容詳解

### 1. 連損與破產風險計算

#### 最長連續虧損次數 (Max Losing Streak)
**定義**：連續虧損的最大次數

**計算方法**：
```python
# 按時間排序，遍歷所有交易
# 記錄連續虧損的次數
# 找出最大值
```

**解讀**：
- **< 5 次**：正常範圍
- **5-10 次**：需要注意
- **> 10 次**：嚴重問題，策略可能在某些市場環境下完全失效

**你的數據**：18 次（極高風險）

---

#### 破產風險 (Risk of Ruin)
**定義**：在當前交易策略下，最終破產的概率

**計算公式**：
```
RoR = ((1-W)/W)^(C/(A*W))

其中：
- W = 勝率
- C = 初始資金
- A = 平均獲利
```

**解讀**：
- **< 1%**：安全
- **1-5%**：可接受
- **5-20%**：高風險
- **> 20%**：極高風險
- **100%**：必然破產

**你的數據**：100%（必然破產）
- 勝率：29.71%（太低）
- 賠率：1.58:1（不夠高）
- 期望值：-0.39 USDT（負值）

---

#### 恢復係數 (Recovery Factor)
**定義**：在經歷最大回撤後，需要多少%的獲利才能回到原點

**計算公式**：
```
恢復係數 = |回撤%| / (1 + 回撤%/100) * 100

例如：
- 虧損 20% → 需要獲利 25%
- 虧損 50% → 需要獲利 100%
- 虧損 90% → 需要獲利 900%
```

**解讀**：
- **< 20%**：容易恢復
- **20-50%**：需要努力
- **50-100%**：困難
- **> 100%**：幾乎不可能

**你的數據**：1098.52%（幾乎不可能恢復）
- 最大回撤：-9.90%
- 需要獲利：10.98 倍

---

### 2. 手續費壓力測試

#### 手續費佔總虧損比例
**定義**：手續費在總虧損中的佔比

**計算方法**：
```python
fee_to_loss_ratio = (總手續費 / 總虧損) * 100
```

**解讀**：
- **< 10%**：正常
- **10-30%**：偏高
- **> 30%**：嚴重問題

**你的數據**：33.34%（嚴重問題）
- 總手續費：103.67 USDT
- 總虧損：310.91 USDT

---

#### 短線交易分析（<5分鐘）
**定義**：持倉時間少於 5 分鐘的交易

**分析內容**：
- 數量和佔比
- 總盈虧
- 勝率
- 期望值

**你的數據**：
- 數量：109 筆（39.5%）
- 總盈虧：-34.06 USDT
- 勝率：24.77%（極低）
- 期望值：-0.34 USDT（負值）

---

#### 停止短線交易模擬
**定義**：如果停止所有短線交易，淨值會有什麼變化

**計算方法**：
```python
# 排除所有持倉時間 < 5 分鐘的交易
# 重新計算總盈虧
# 對比原始淨值
```

**你的數據**：
- 原始淨值：-94.86 USDT
- 新淨值：-60.80 USDT
- 改善：+34.06 USDT (+35.91%)
- 節省手續費：44.32 USDT

**結論**：停止短線交易可以立即改善淨值 36%！

---

### 3. 傾斜 (Tilt) 檢測

#### 什麼是傾斜？
**定義**：虧損後的情緒化交易行為，通常表現為：
- 報復性加倉（想「回本」）
- 增加槓桿（想「快速翻本」）
- 賭徒謬誤（認為「下一次一定會贏」）

#### 檢測方法
```python
# 遍歷所有交易
# 如果當前交易虧損：
#   檢查下一筆交易的槓桿和倉位
#   如果增加 > 20%，記錄為傾斜行為
```

#### 嚴重程度分級
- **none**：無傾斜行為
- **low**：< 10% 的交易
- **medium**：10-20% 的交易
- **high**：> 20% 的交易

**你的數據**：
- 嚴重程度：high（高度嚴重）
- 傾斜案例：95 次（34.5%）
- 虧損後平均槓桿變化：+18.34x
- 獲利後平均槓桿變化：-32.69x

**解讀**：
- 虧損後增加槓桿（報復性交易）
- 獲利後減少槓桿（過度謹慎）
- 完全相反的邏輯，說明情緒主導交易

---

## 🔧 自定義分析

### 修改數據來源

編輯 `quantitative_risk_analysis.py`：

```python
# 修改數據路徑
risk_officer = QuantitativeRiskOfficer(
    trades_data_path='你的數據路徑.json'
)
```

### 修改短線交易閾值

```python
# 修改為 10 分鐘
short_trades = risk_officer.analyze_short_term_trades(threshold_minutes=10.0)
```

### 修改傾斜檢測閾值

編輯 `detect_tilt_behavior()` 方法：

```python
# 修改為 30% 才算傾斜
if leverage_increase > 30 or quantity_increase > 30:
    tilt_cases.append(...)
```

---

## 📈 整合到 Web 界面

### 方案 1：添加新頁面

在 `web_dashboard_v2.py` 中添加：

```python
# 在側邊欄添加新選項
page = st.sidebar.radio(
    "選擇功能",
    ["交易覆盤", "市場分析", "量化風險分析"]  # 新增
)

# 添加新頁面
if page == "量化風險分析":
    st.title("🔍 量化風險分析")
    
    # 載入分析工具
    from quantitative_risk_analysis import QuantitativeRiskOfficer
    risk_officer = QuantitativeRiskOfficer()
    
    # 顯示分析結果
    st.subheader("1. 連損與破產風險")
    max_streak = risk_officer.calculate_max_losing_streak()
    st.metric("最長連續虧損", f"{max_streak['max_streak']} 次")
    
    ror = risk_officer.calculate_risk_of_ruin()
    st.metric("破產風險", f"{ror['risk_of_ruin']:.2%}")
    
    # ... 更多分析
```

### 方案 2：添加警報功能

```python
# 在交易覆盤頁面添加風險警報
if st.button("執行風險檢查"):
    risk_officer = QuantitativeRiskOfficer()
    
    # 檢查破產風險
    ror = risk_officer.calculate_risk_of_ruin()
    if ror['risk_of_ruin'] > 0.5:
        st.error(f"⚠️ 破產風險過高：{ror['risk_of_ruin']:.2%}")
    
    # 檢查傾斜行為
    tilt = risk_officer.detect_tilt_behavior()
    if tilt['has_tilt']:
        st.warning(f"⚠️ 檢測到傾斜行為：{tilt['tilt_cases_count']} 次")
    
    # 檢查短線交易
    short = risk_officer.analyze_short_term_trades()
    if short['expectancy'] < 0:
        st.warning(f"⚠️ 短線交易期望值為負：{short['expectancy']:.2f} USDT")
```

---

## 💡 實用技巧

### 1. 定期運行分析

建議每週運行一次量化風險分析：

```bash
# 創建定時任務
crontab -e

# 添加：每週日晚上 10 點運行
0 22 * * 0 cd /path/to/project && python3 quantitative_risk_analysis.py > weekly_risk_report.txt
```

### 2. 導出報告

```python
# 修改 generate_full_report() 方法
def generate_full_report(self, output_file: str = None):
    report = self._generate_report_text()
    
    if output_file:
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(report)
    
    print(report)
    return report

# 使用
risk_officer.generate_full_report(output_file='risk_report_2026-02-09.txt')
```

### 3. 比較不同時期

```python
# 分析最近 30 天
recent_trades = df[df['close_time'] > datetime.now() - timedelta(days=30)]
risk_officer_recent = QuantitativeRiskOfficer()
risk_officer_recent.df = recent_trades
risk_officer_recent.generate_full_report()
```

---

## 🎯 行動建議

根據你的分析結果，建議立即採取以下行動：

### 緊急（今天）
1. ✅ **停止所有 5 分鐘內的短線交易**
2. ✅ **實施傾斜檢測：虧損後禁止增加槓桿**
3. ✅ **降低最大槓桿至 20x**

### 本週
4. ⚠️ **暫停交易，重新優化策略**（期望值為負）
5. ⚠️ **提高進場標準**（提升勝率至 50%+）
6. ⚠️ **改善風險回報比**（賠率提升至 2:1+）

### 本月
7. 📊 **整合量化風險分析到 Web 界面**
8. 📊 **添加實時破產風險監控**
9. 📊 **實施自動傾斜檢測和警報**

---

## 📚 相關資源

- **工具文件**：`quantitative_risk_analysis.py`
- **對比報告**：`量化風險分析對比報告.md`
- **數據來源**：`data/review_history/quality_scores.json`

---

**更新日期**：2026-02-09  
**版本**：v1.0.0
