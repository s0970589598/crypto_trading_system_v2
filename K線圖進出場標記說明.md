# K線圖進出場標記功能說明

## 功能概述

在市場分析的多時區K線圖中，現在會自動標記交易的進場和出場位置，讓你更清楚地看到交易的進出點。

## 數據來源

系統會從交易記錄中讀取：
- **進場時間**：`open_time` 欄位
- **出場時間**：`close_time` 欄位

在圖表上方會顯示交易時間信息和K線時間說明。

## 標記說明

### 1. 進場標記
- **圖標**：三角形（▲ 做多 / ▼ 做空）
- **顏色**：
  - 🟢 綠色：做多（Long）
  - 🔴 紅色：做空（Short）
- **位置**：
  - 做多：標記在K線**下方**（避免遮擋）
  - 做空：標記在K線**上方**（避免遮擋）
- **文字**：顯示「進場」和實際時間（HH:MM:SS）

### 2. 出場標記
- **圖標**：X 符號
- **顏色**：
  - 🟡 金色：獲利出場
  - 🔴 番茄紅：虧損出場
- **位置**：
  - 獲利：標記在K線**上方**
  - 虧損：標記在K線**下方**
- **文字**：顯示「出場」和實際時間（HH:MM:SS）

### 3. 持倉期間連線
- **樣式**：實線連接進場和出場的實際價格
- **顏色**：
  - 🟢 綠色：獲利交易
  - 🔴 紅色：虧損交易
- **作用**：清楚顯示持倉期間的價格變化

## K線時間說明

### 重要概念
K線的時間代表該K線的**開始時間**，而不是交易的精確時間。

### 示例說明
- **15分鐘K線**：8:45 的K線代表 **8:45-9:00** 的時間段
- **交易時間**：8:50:22 的交易會標記在 **8:45** 的K線上
- **這是正確的**：因為 8:50:22 在 8:45-9:00 這個時間段內

### 不同時區的K線時間段
- **15m**：每根K線代表 15 分鐘（例如：8:45-9:00）
- **1h**：每根K線代表 1 小時（例如：8:00-9:00）
- **4h**：每根K線代表 4 小時（例如：8:00-12:00）
- **1d**：每根K線代表 1 天（例如：00:00-23:59）

### 為什麼這樣設計？
1. **符合K線定義**：K線本身就是時間段的統計數據
2. **視覺清晰**：標記在對應的K線上，方便分析
3. **技術分析**：可以看到進出場時該K線的完整形態

## 標記位置優化

### 避免遮擋K線
標記會根據K線的高低點自動調整位置：

**進場標記**：
- 做多（看漲）：標記在K線下方，不會遮擋價格走勢
- 做空（看跌）：標記在K線上方，不會遮擋價格走勢

**出場標記**：
- 獲利：標記在K線上方（慶祝的感覺）
- 虧損：標記在K線下方（反思的位置）

### 標記間距
標記與K線的距離為該K線高低差的 50%，確保：
- 不會太遠（保持關聯性）
- 不會太近（避免遮擋）
- 波動大時自動調整（動態間距）

## 顯示範圍調整

系統會智能調整K線圖的顯示範圍：

- **有出場時間**：顯示進場前30根 + 持倉期間 + 出場後30根K線
- **無出場時間**：顯示進場前後各50根K線

這樣可以確保進場和出場點都在可視範圍內，同時保留足夠的上下文。

## 使用場景

### 1. 覆盤分析
- 查看進場時機是否合適
- 觀察持倉期間的價格走勢
- 評估出場時機是否理想

### 2. 策略驗證
- 確認進場點是否符合技術指標信號
- 檢查是否在關鍵支撐/阻力位進出場
- 分析持倉期間的市場變化

### 3. 學習改進
- 對比成功和失敗的交易
- 找出進出場的共同特徵
- 改進交易決策流程

## 圖例說明

在K線圖的圖例中會顯示：
- 📍 進場：標記進場位置
- 📍 出場：標記出場位置
- 📊 持倉期間：連接進出場的虛線

## 注意事項

1. **時間精度**：標記會顯示在最接近實際交易時間的K線上
2. **多時區**：每個時區（15m、1h、4h、1d）都會獨立顯示標記
3. **數據要求**：需要有對應時區的市場數據才能顯示標記

## 示例

```
進場（做多）：綠色三角形 ▲
持倉期間：綠色虛線 ----
出場（獲利）：金色 X
```

這樣的視覺化設計讓你一眼就能看出：
- 交易方向（做多/做空）
- 進出場位置
- 交易結果（獲利/虧損）
- 持倉期間的價格變化

## 更新日期

2026-02-06
