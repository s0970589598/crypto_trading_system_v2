# 交易覆盤統計分析功能說明

## 新增功能

在交易覆盤頁面新增兩個重要的統計分析區域：
1. **💰 實際收益率分析** - 分析考慮槓桿後的真實收益表現
2. **⏱️ 持倉時間分析** - 分析不同持倉時間的交易表現

---

## 1. 實際收益率分析

### 顯示內容

#### 總體統計（4個指標）
```
┌──────────────┬────────┬────────────┬────────────┐
│ 平均實際收益率│ 勝率   │ 平均獲利   │ 平均虧損   │
│ +15.50%      │ 65.0%  │ +45.20%    │ -18.30%    │
└──────────────┴────────┴────────────┴────────────┘
```

#### 區間分析表格
| 區間 | 交易數 | 佔比 | 平均收益率 | 總盈虧 |
|------|--------|------|------------|--------|
| 大賺 (≥50%) | 5 | 10.0% | +75.50% | +250.00 USDT |
| 獲利 (20-50%) | 10 | 20.0% | +32.20% | +180.50 USDT |
| 小賺 (5-20%) | 15 | 30.0% | +12.50% | +95.20 USDT |
| 持平 (±5%) | 8 | 16.0% | +1.20% | +5.50 USDT |
| 小虧 (-5~-20%) | 8 | 16.0% | -12.30% | -45.80 USDT |
| 虧損 (-20~-50%) | 3 | 6.0% | -32.50% | -85.20 USDT |
| 大虧 (<-50%) | 1 | 2.0% | -75.00% | -120.00 USDT |

### 分析價值

#### 1. 識別收益分布
- **大賺交易佔比**：看看是否有足夠的大賺交易
- **虧損交易佔比**：控制虧損交易的比例

#### 2. 評估風險回報
- **平均獲利 vs 平均虧損**：理想比例應該 > 1.5:1
- **範例**：平均獲利 +45%，平均虧損 -18%，比例 = 2.5:1 ✅

#### 3. 發現問題
- **大虧交易過多**：可能槓桿太高或止損不及時
- **小賺交易過多**：可能出場太早，沒有讓利潤奔跑

---

## 2. 持倉時間分析

### 顯示內容

#### 統計表格
| 持倉時間 | 交易數 | 佔比 | 勝率 | 平均盈虧 | 平均收益率 | 總盈虧 |
|----------|--------|------|------|----------|------------|--------|
| 極短 (<6分鐘) | 5 | 10.0% | 40.0% | -2.50 USDT | -15.20% | -12.50 USDT |
| 超短線 (<1小時) | 15 | 30.0% | 53.3% | +1.20 USDT | +8.50% | +18.00 USDT |
| 日內 (1-4小時) | 20 | 40.0% | 65.0% | +5.50 USDT | +22.30% | +110.00 USDT |
| 短線 (4-24小時) | 8 | 16.0% | 75.0% | +12.50 USDT | +35.20% | +100.00 USDT |
| 波段 (1-3天) | 2 | 4.0% | 50.0% | +8.00 USDT | +18.50% | +16.00 USDT |
| 長線 (>3天) | 0 | 0.0% | - | - | - | - |

#### 視覺化圖表
- **持倉時間分布柱狀圖**：清楚看到交易集中在哪個時間區間

### 分析價值

#### 1. 找出最佳持倉時間
**範例分析**：
- 極短線（<6分鐘）：勝率 40%，平均虧損 ❌
- 日內（1-4小時）：勝率 65%，平均獲利 +5.50 USDT ✅
- 短線（4-24小時）：勝率 75%，平均獲利 +12.50 USDT ✅✅

**結論**：應該避免極短線交易，專注於日內和短線交易。

#### 2. 識別交易風格
- **超短線為主（<1小時）**：可能是剝頭皮交易者
- **日內為主（1-4小時）**：日內交易者
- **短線為主（4-24小時）**：波段交易者

#### 3. 發現問題
- **極短線交易過多**：可能是衝動交易或過度交易
- **持倉時間過長**：可能錯過出場時機

---

## 使用場景

### 場景 1：優化交易策略

**步驟**：
1. 查看持倉時間分析
2. 找出勝率最高的時間區間
3. 調整策略，專注於該時間區間

**範例**：
- 發現日內交易（1-4小時）勝率 65%，平均獲利 +5.50 USDT
- 發現極短線（<6分鐘）勝率 40%，平均虧損 -2.50 USDT
- **行動**：減少極短線交易，增加日內交易

---

### 場景 2：評估槓桿使用

**步驟**：
1. 查看實際收益率分析
2. 對比價格變動%和實際收益率
3. 評估槓桿是否合理

**範例**：
- 平均價格變動：+0.5%
- 平均實際收益率：+25%
- 推算平均槓桿：50x
- **結論**：槓桿過高，小幅價格變動就導致大幅收益波動

---

### 場景 3：風險控制

**步驟**：
1. 查看實際收益率區間分析
2. 檢查大虧（<-50%）交易的佔比
3. 分析這些交易的共同特徵

**範例**：
- 大虧交易佔比 5%
- 這些交易都是極短線 + 高槓桿（>100x）
- **行動**：限制極短線交易的槓桿使用

---

## 數據要求

### 實際收益率分析需要：
- ✅ `entry_price`：進場價格
- ✅ `exit_price`：出場價格
- ✅ `leverage`：槓桿倍數
- ✅ `direction`：交易方向（Long/Short）
- ✅ `pnl`：盈虧金額

### 持倉時間分析需要：
- ✅ `open_time`：進場時間
- ✅ `close_time`：出場時間
- ✅ `pnl`：盈虧金額

### 如何獲取這些數據？
**重新評分**即可！系統會自動從原始交易數據中提取並保存這些字段。

---

## 操作步驟

### 1. 確保數據完整

**檢查是否需要重新評分**：
- 如果看到提示「💡 需要重新評分才能看到分析」
- 說明舊的評分記錄缺少必要字段

**重新評分**：
1. 在交易覆盤頁面選擇交易
2. 點擊「自動評分」
3. 等待完成

### 2. 查看統計分析

**位置**：
- 交易覆盤頁面
- 在「📈 評分趨勢」圖表之後
- 在「📋 詳細評分」列表之前

**內容**：
1. 💰 實際收益率分析
   - 總體統計（4個指標）
   - 區間分析表格
2. ⏱️ 持倉時間分析
   - 統計表格
   - 分布柱狀圖

### 3. 分析和改進

**分析流程**：
1. 查看總體統計，了解整體表現
2. 查看區間分析，找出問題區間
3. 查看持倉時間分析，找出最佳時間區間
4. 根據分析結果調整交易策略

---

## 實際範例

### 範例 1：發現過度交易問題

**數據**：
- 極短線（<6分鐘）：20筆，佔比 40%
- 勝率：35%
- 平均虧損：-3.50 USDT
- 總虧損：-70.00 USDT

**分析**：
- 極短線交易過多（40%）
- 勝率低（35%）
- 平均虧損較大

**結論**：
- 可能是衝動交易或過度交易
- 手續費佔比過高

**行動**：
- 減少極短線交易
- 設置最小持倉時間（如 30 分鐘）
- 提高進場標準

---

### 範例 2：發現最佳持倉時間

**數據**：
| 持倉時間 | 交易數 | 勝率 | 平均盈虧 | 總盈虧 |
|----------|--------|------|----------|--------|
| 超短線 (<1小時) | 10 | 50% | +1.00 | +10.00 |
| 日內 (1-4小時) | 15 | 70% | +8.00 | +120.00 |
| 短線 (4-24小時) | 5 | 80% | +15.00 | +75.00 |

**分析**：
- 持倉時間越長，勝率越高
- 日內和短線交易表現最好

**結論**：
- 最佳持倉時間：1-24 小時
- 應該增加耐心，讓利潤奔跑

**行動**：
- 減少超短線交易
- 增加日內和短線交易
- 調整止盈策略，避免過早出場

---

### 範例 3：發現槓桿問題

**實際收益率分析**：
- 大虧（<-50%）：5筆，佔比 10%
- 這些交易的平均槓桿：120x
- 平均價格變動：-0.5%
- 平均實際虧損：-60%

**分析**：
- 極高槓桿（120x）
- 小幅價格變動（-0.5%）導致巨大虧損（-60%）

**結論**：
- 槓桿過高是主要問題
- 風險管理不足

**行動**：
- 限制最大槓桿（如 20x）
- 根據波動率調整槓桿
- 設置更嚴格的止損

---

## 技術細節

### 實際收益率計算

```python
# 1. 計算價格變動%
if direction == 'Long':
    pnl_pct = ((exit_price - entry_price) / entry_price) * 100
else:  # Short
    pnl_pct = ((entry_price - exit_price) / entry_price) * 100

# 2. 計算實際收益率
actual_return = pnl_pct * leverage
```

### 持倉時間計算

```python
# 計算持倉小時數
holding_hours = (close_time - open_time).total_seconds() / 3600

# 分類
if holding_hours < 0.1:
    category = '極短 (<6分鐘)'
elif holding_hours < 1:
    category = '超短線 (<1小時)'
# ... 更多分類
```

---

## 相關文檔

- `實際收益率顯示說明.md` - 實際收益率的詳細說明
- `交易詳細信息顯示優化說明.md` - 交易詳細信息顯示
- `槓桿與風險管理.md` - 槓桿使用建議

---

## 更新日期
2026-02-09

## 版本
v2.2.0
