# K線圖價格顯示修正說明

## 問題描述

在市場分析的K線圖中，進場和出場標記顯示的價格不正確：
- **問題**：顯示的是K線的收盤價，而不是實際的進場/出場價格
- **影響**：無法準確看到實際的交易價格

---

## 問題原因

### 原始代碼（錯誤）

```python
# 進場價格使用K線收盤價
entry_price = df.loc[entry_idx, 'close']  # ❌ 錯誤

# 出場價格使用K線收盤價
exit_price = df.loc[exit_idx, 'close']  # ❌ 錯誤
```

**問題**：
- 交易可能發生在K線的任何時間點
- 實際進場/出場價格可能與K線收盤價不同
- 導致標記顯示的價格不準確

---

## 修正方案

### 修正後代碼（正確）

```python
# 使用實際進場價格
entry_price = selected_row.get('entry_price', df.loc[entry_idx, 'close'])  # ✅ 正確

# 使用實際出場價格
exit_price = selected_row.get('exit_price', df.loc[exit_idx, 'close'])  # ✅ 正確
```

**改進**：
1. 優先使用 `selected_row` 中的實際進場/出場價格
2. 如果沒有實際價格，才使用K線收盤價作為備用
3. 在標記上同時顯示時間和價格

---

## 修正內容

### 1. 進場標記

**修正前**：
```python
text=[f'進場<br>{entry_time[11:19]}']  # 只顯示時間
```

**修正後**：
```python
text=[f'進場<br>{entry_time[11:19]}<br>${entry_price:.2f}']  # 顯示時間和價格
```

**效果**：
```
進場
08:50:22
$42,150.50
```

---

### 2. 出場標記

**修正前**：
```python
text=[f'出場<br>{exit_time[11:19]}']  # 只顯示時間
```

**修正後**：
```python
text=[f'出場<br>{exit_time[11:19]}<br>${exit_price:.2f}']  # 顯示時間和價格
```

**效果**：
```
出場
09:23:54
$42,850.75
```

---

### 3. 持倉期間連線

連線使用實際的進場/出場價格：
```python
y=[entry_price, exit_price]  # 使用實際價格
```

**效果**：
- 連線準確反映實際的價格變化
- 可以清楚看到盈虧幅度

---

## 視覺效果

### 修正前
```
K線圖
  |
  |  ▲ 進場 (顯示K線收盤價，可能不準確)
  |  08:50:22
  |
  |  X 出場 (顯示K線收盤價，可能不準確)
  |  09:23:54
```

### 修正後
```
K線圖
  |
  |  ▲ 進場 (顯示實際進場價格)
  |  08:50:22
  |  $42,150.50
  |
  |  X 出場 (顯示實際出場價格)
  |  09:23:54
  |  $42,850.75
```

---

## 優點

### 1. 準確性
- 顯示實際的交易價格
- 不再依賴K線收盤價
- 更準確反映交易情況

### 2. 完整性
- 同時顯示時間和價格
- 信息更完整
- 更容易分析

### 3. 可讀性
- 價格格式化（保留2位小數）
- 清晰的標記位置
- 不遮擋K線

---

## 使用說明

### 查看進場/出場價格

1. **進入交易覆盤頁面**
   - 選擇一筆交易
   - 點擊「🔬 市場分析」標籤

2. **查看K線圖**
   - 選擇時間週期（15m/1h/4h/1d）
   - 查看進場/出場標記

3. **標記信息**
   - **進場標記**：綠色▲（做多）或紅色▼（做空）
   - **出場標記**：金色X（獲利）或紅色X（虧損）
   - **顯示內容**：時間 + 價格

---

## 範例

### 做多獲利交易

```
進場標記（綠色▲）：
  進場
  08:50:22
  $42,150.50

出場標記（金色X）：
  出場
  09:23:54
  $42,850.75

盈虧：+$700.25 (+1.66%)
```

### 做空虧損交易

```
進場標記（紅色▼）：
  進場
  14:30:15
  $43,200.00

出場標記（紅色X）：
  出場
  15:45:30
  $43,450.50

盈虧：-$250.50 (-0.58%)
```

---

## 技術細節

### 數據來源

```python
# 從交易記錄中獲取
entry_price = selected_row.get('entry_price')  # 實際進場價格
exit_price = selected_row.get('exit_price')    # 實際出場價格
```

### 備用方案

如果交易記錄中沒有價格數據：
```python
# 使用K線收盤價作為備用
entry_price = selected_row.get('entry_price', df.loc[entry_idx, 'close'])
```

### 價格格式化

```python
f'${entry_price:.2f}'  # 保留2位小數，添加$符號
```

---

## 注意事項

### 1. 數據完整性
- 確保交易記錄中有 `entry_price` 和 `exit_price` 字段
- 如果沒有，會使用K線收盤價作為備用

### 2. 價格精度
- 顯示保留2位小數
- 適用於大部分加密貨幣交易對

### 3. 標記位置
- 標記位置在K線上方或下方
- 避免遮擋K線本身
- 連線使用實際價格

---

## 相關文檔

- `K線圖進出場標記說明.md` - K線標記功能說明
- `K線標記位置說明.md` - 標記位置邏輯說明
- `進出場標記修正說明.md` - 進出場時間修正說明

---

## 更新日期
2026-02-06

## 版本
v2.1.2
