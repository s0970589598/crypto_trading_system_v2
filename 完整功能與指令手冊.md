# 🎯 完整功能與指令手冊

## 📋 目錄

1. [系統完整功能清單](#系統完整功能清單)
2. [所有可用策略](#所有可用策略)
3. [情境指令大全](#情境指令大全)
4. [Python API 使用](#python-api-使用)
5. [工具腳本](#工具腳本)

---

## 🎯 系統完整功能清單

### 1. 回測系統 (Backtesting)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 單策略回測 | 測試單個策略表現 | ✅ 完成 |
| 多策略組合回測 | 同時測試多個策略 | ✅ 完成 |
| 多週期數據支持 | 支持 15m/1h/4h/1d | ✅ 完成 |
| 槓桿對比測試 | 測試不同槓桿效果 | ✅ 完成 |
| 倉位對比測試 | 測試滿倉 vs 部分倉位 | ✅ 完成 |
| 自定義時間範圍 | 指定回測時間段 | ✅ 完成 |
| 績效指標計算 | 收益/勝率/回撤等 | ✅ 完成 |
| 結果保存 | JSON 格式保存 | ✅ 完成 |
| 交易明細導出 | CSV 格式導出 | ✅ 完成 |

### 2. 實盤交易 (Live Trading)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 單策略實盤 | 運行單個策略 | ✅ 完成 |
| 多策略並行 | 同時運行多個策略 | ✅ 完成 |
| 乾跑模式 | 不實際下單測試 | ✅ 完成 |
| 自動下單 | 自動執行交易 | ✅ 完成 |
| Telegram 通知 | 實時推送信號 | ✅ 完成 |
| 風險控制 | 自動止損/限倉 | ✅ 完成 |
| 策略熱重載 | 不停機更新配置 | ✅ 完成 |
| 異常處理 | 網絡/API 錯誤處理 | ✅ 完成 |

### 3. 參數優化 (Optimization)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 網格搜索 | 遍歷所有參數組合 | ✅ 完成 |
| 隨機搜索 | 隨機採樣參數空間 | ✅ 完成 |
| 貝葉斯優化 | 智能參數搜索 | ✅ 完成 |
| 訓練/驗證集分離 | 防止過擬合 | ✅ 完成 |
| 參數敏感度分析 | 分析參數影響 | ✅ 完成 |
| 多目標優化 | 同時優化多個指標 | ✅ 完成 |
| 優化報告生成 | 詳細優化結果 | ✅ 完成 |

### 4. 虧損分析 (Loss Analysis)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 虧損原因分類 | 自動分類虧損原因 | ✅ 完成 |
| 虧損模式識別 | 識別常見虧損模式 | ✅ 完成 |
| 改進建議生成 | 基於分析生成建議 | ✅ 完成 |
| 自定義分類規則 | 用戶定義規則 | ✅ 完成 |
| 虧損趨勢追蹤 | 追蹤改善情況 | ✅ 完成 |
| 虧損報告導出 | 詳細分析報告 | ✅ 完成 |

### 5. 性能監控 (Performance Monitoring)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 實時指標追蹤 | 實時計算收益率 | ✅ 完成 |
| 異常檢測 | 檢測異常表現 | ✅ 完成 |
| 策略退化檢測 | 檢測性能下降 | ✅ 完成 |
| 自動暫停策略 | 連損自動暫停 | ✅ 完成 |
| 警報系統 | Telegram 警報 | ✅ 完成 |
| 性能報告 | 定期性能報告 | ✅ 完成 |


### 6. 交易覆盤 (Trade Review)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 交易記錄管理 | 完整交易記錄 | ✅ 完成 |
| 執行質量評分 | 評估執行質量 | ✅ 完成 |
| 交易註記 | 添加交易筆記 | ✅ 完成 |
| 覆盤報告生成 | 每日/週/月報告 | ✅ 完成 |
| 技能改善追蹤 | 追蹤進步情況 | ✅ 完成 |
| 數據導出 | CSV/JSON 導出 | ✅ 完成 |

### 7. 策略管理 (Strategy Management)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 策略載入 | 從配置文件載入 | ✅ 完成 |
| 策略驗證 | 驗證策略邏輯 | ✅ 完成 |
| 策略啟用/禁用 | 動態控制策略 | ✅ 完成 |
| 策略熱重載 | 不停機更新 | ✅ 完成 |
| 策略版本管理 | 版本控制 | ✅ 完成 |
| 策略部署 | 一鍵部署 | ✅ 完成 |
| 策略模板 | 快速創建新策略 | ✅ 完成 |

### 8. 風險管理 (Risk Management)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 全局風險控制 | 總倉位/回撤限制 | ✅ 完成 |
| 策略級風險控制 | 單策略限制 | ✅ 完成 |
| 動態倉位調整 | 根據風險調整 | ✅ 完成 |
| 連損暫停 | 自動暫停交易 | ✅ 完成 |
| 每日虧損限制 | 每日止損 | ✅ 完成 |
| 風險事件記錄 | 記錄所有風險事件 | ✅ 完成 |

### 9. 數據管理 (Data Management)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| 多數據源支持 | Binance/BingX | ✅ 完成 |
| 數據緩存 | 減少 API 調用 | ✅ 完成 |
| 數據源切換 | 自動容錯切換 | ✅ 完成 |
| 數據驗證 | 完整性驗證 | ✅ 完成 |
| 數據持久化 | CSV/JSON 保存 | ✅ 完成 |
| 歷史數據下載 | 批量下載數據 | ✅ 完成 |

### 10. 系統配置 (System Configuration)

| 功能 | 說明 | 實現狀態 |
|------|------|---------|
| YAML 配置 | 系統配置文件 | ✅ 完成 |
| 環境變數支持 | .env 文件支持 | ✅ 完成 |
| 配置驗證 | 自動驗證配置 | ✅ 完成 |
| 動態配置更新 | 運行時更新 | ✅ 完成 |
| 配置優先級 | 環境變數 > 文件 | ✅ 完成 |

---

## 🎮 所有可用策略

### 策略 1：多週期共振策略（激進模式）⭐⭐⭐⭐⭐

**文件**：`strategies/multi-timeframe-aggressive.json`

**類型**：趨勢跟隨

**特點**：
- 使用 4 個週期（15m/1h/4h/1d）
- 較緊的止損（1.5 ATR）
- 較高的目標（3.0 ATR）
- 適合強趨勢市場

**配置**：
```json
{
  "止損": "1.5 ATR",
  "目標": "3.0 ATR",
  "倉位": "20%",
  "槓桿": "5x",
  "RSI 超賣": 30,
  "RSI 超買": 70
}
```

**回測表現**：
- 收益：+28.37%（3個月）
- 勝率：50%
- 回撤：-16.52%
- 風險調整收益：1.72

**適用場景**：
- ✅ 強趨勢市場
- ✅ 波動率適中
- ❌ 震盪市場

---

### 策略 2：多週期共振策略（輕鬆模式）⭐⭐⭐⭐

**文件**：`strategies/multi-timeframe-relaxed.json`

**類型**：趨勢跟隨

**特點**：
- 使用 4 個週期（15m/1h/4h/1d）
- 較寬的止損（2.0 ATR）
- 較高的目標（4.0 ATR）
- 適合震盪市場

**配置**：
```json
{
  "止損": "2.0 ATR",
  "目標": "4.0 ATR",
  "倉位": "20%",
  "槓桿": "5x",
  "RSI 超賣": 30,
  "RSI 超買": 70
}
```

**回測表現**：
- 收益：+20.89%（3個月）
- 勝率：50%
- 回撤：-19.66%
- 風險調整收益：1.06

**適用場景**：
- ✅ 震盪市場
- ✅ 高波動率
- ❌ 單邊趨勢

---

### 策略 3：突破策略 ⭐⭐⭐

**文件**：`strategies/breakout-strategy.json`

**類型**：突破交易

**特點**：
- 識別盤整區間
- 突破時進場
- 較緊的止損（1.5 ATR）
- 適合盤整後突破

**配置**：
```json
{
  "止損": "1.5 ATR",
  "目標": "2.0 ATR",
  "倉位": "15%",
  "槓桿": "3x",
  "盤整週期": 20
}
```

**適用場景**：
- ✅ 盤整後突破
- ✅ 關鍵位突破
- ❌ 持續趨勢

---

### 策略 4：均值回歸策略 ⭐⭐⭐

**文件**：`strategies/mean-reversion.json`

**類型**：反轉交易

**特點**：
- 超買超賣反轉
- 布林帶策略
- 較寬的止損（2.0 ATR）
- 適合震盪市場

**配置**：
```json
{
  "止損": "2.0 ATR",
  "目標": "4.0 ATR",
  "倉位": "15%",
  "槓桿": "5x",
  "布林帶週期": 20,
  "布林帶標準差": 2
}
```

**適用場景**：
- ✅ 震盪市場
- ✅ 超買超賣
- ❌ 強趨勢

---

### 策略 5：示例策略（模板）

**文件**：`strategies/example-strategy.json`

**類型**：模板

**用途**：作為創建新策略的模板

---

## 📚 情境指令大全

### 情境 1：我想測試策略是否有效

```bash
# 方法 1：使用專用腳本（最簡單）
python3 backtest_multi_timeframe.py

# 方法 2：使用 CLI
python3 cli.py backtest --strategy multi-timeframe-aggressive

# 方法 3：指定時間範圍
python3 cli.py backtest \
  --strategy multi-timeframe-aggressive \
  --start 2024-10-01 \
  --end 2026-01-21

# 方法 4：測試所有策略
python3 cli.py backtest --strategy multi-timeframe-aggressive
python3 cli.py backtest --strategy multi-timeframe-relaxed
python3 cli.py backtest --strategy breakout-strategy
python3 cli.py backtest --strategy mean-reversion

# 查看結果
python3 快速查看.py
```

---

### 情境 2：我想找最佳槓桿

```bash
# 測試所有槓桿（1x, 2x, 3x, 5x, 10x, 20x）
python3 backtest_leverage_comparison.py

# 查看結果
python3 快速查看.py

# 或直接查看 CSV
cat leverage_comparison_激進模式_1.5_ATR.csv
```

---

### 情境 3：我想測試滿倉效果

```bash
# 測試滿倉（100% 倉位）
python3 full_position_backtest.py

# 對比 20% 倉位
python3 backtest_multi_timeframe.py

# 查看對比
python3 快速查看.py
```

---

### 情境 4：我想優化策略參數

```bash
# 方法 1：使用示例腳本
python3 example_optimizer.py

# 方法 2：使用 CLI - 網格搜索
python3 cli.py optimize \
  --strategy multi-timeframe-aggressive \
  --method grid \
  --param stop_loss_atr:1.0,1.5,2.0 \
  --param take_profit_atr:2.0,3.0,4.0

# 方法 3：隨機搜索
python3 cli.py optimize \
  --strategy multi-timeframe-aggressive \
  --method random \
  --iterations 100

# 方法 4：貝葉斯優化
python3 cli.py optimize \
  --strategy multi-timeframe-aggressive \
  --method bayesian \
  --iterations 50
```

---

### 情境 5：我想分析為什麼虧損

```bash
# 運行虧損分析
python3 example_loss_analyzer.py

# 或使用 Python API
python3 << 'EOF'
from src.analysis.loss_analyzer import LossAnalyzer
import json

# 載入交易記錄
with open('backtest_result_multi-timeframe-aggressive_latest.json') as f:
    result = json.load(f)

# 分析虧損
analyzer = LossAnalyzer()
analysis = analyzer.analyze_losses(result['trades'])

# 查看結果
print("虧損原因分佈:")
for reason, pct in analysis['loss_reasons'].items():
    print(f"  {reason}: {pct:.1f}%")

print("\n改進建議:")
for rec in analysis['recommendations']:
    print(f"  - {rec}")
EOF
```

---

### 情境 6：我想開始實盤交易

```bash
# 步驟 1：配置 API 密鑰
cat > .env << 'EOF'
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
EOF

# 步驟 2：測試 Telegram
python3 test_telegram.py

# 步驟 3：乾跑模式測試（不實際下單）
python3 cli.py live \
  --strategy multi-timeframe-aggressive \
  --dry-run

# 步驟 4：開始實盤（小資金）
python3 cli.py live --strategy multi-timeframe-aggressive

# 或使用舊版警報系統
bash start_alert.sh
```

---

### 情境 7：我想同時運行多個策略

```bash
# 方法 1：使用 CLI
python3 cli.py live \
  --strategies multi-timeframe-aggressive,breakout-strategy \
  --allocation 0.6,0.4

# 方法 2：使用多策略腳本
python3 backtest_multi_strategy.py

# 方法 3：分別啟動（不同終端）
# 終端 1
python3 cli.py live --strategy multi-timeframe-aggressive

# 終端 2
python3 cli.py live --strategy breakout-strategy
```

---

### 情境 8：我想創建自己的策略

```bash
# 方法 1：使用工具創建
python3 tools/create_strategy.py \
  --name my-strategy \
  --type trend-following

# 方法 2：手動創建
# 複製模板
cp strategy_template.py src/strategies/my_strategy.py
cp strategies/example-strategy.json strategies/my-strategy.json

# 編輯策略代碼
nano src/strategies/my_strategy.py

# 編輯配置
nano strategies/my-strategy.json

# 驗證策略
python3 tools/validate_strategy.py --strategy my-strategy

# 回測新策略
python3 cli.py backtest --strategy my-strategy
```

---

### 情境 9：我想監控策略表現

```bash
# 方法 1：使用性能監控器
python3 example_performance_monitor.py

# 方法 2：使用 Python API
python3 << 'EOF'
from src.analysis.performance_monitor import PerformanceMonitor

monitor = PerformanceMonitor()

# 檢查異常
if monitor.check_anomaly("multi-timeframe-aggressive"):
    print("⚠️ 檢測到策略異常！")

# 檢查退化
if monitor.detect_degradation("multi-timeframe-aggressive"):
    print("⚠️ 策略性能退化！")
EOF

# 方法 3：查看實時日誌
tail -f logs/trading.log
```

---

### 情境 10：我想覆盤我的交易

```bash
# 使用覆盤系統
python3 example_review_system.py

# 或使用 Python API
python3 << 'EOF'
from src.analysis.review_system import ReviewSystem

review = ReviewSystem()

# 生成報告
report = review.generate_report(
    start_date="2026-01-01",
    end_date="2026-01-31"
)

print(f"總交易數: {report['total_trades']}")
print(f"執行質量: {report['execution_quality']:.2f}")
EOF
```

---

### 情境 11：我想下載最新市場數據

```bash
# 下載所有數據
python3 fetch_market_data.py

# 或指定交易對和週期
python3 << 'EOF'
from src.managers.data_manager import DataManager

manager = DataManager()

# 下載 BTC 數據
data = manager.fetch_data(
    symbol="BTCUSDT",
    timeframe="1h",
    start_date="2024-01-01",
    end_date="2026-01-31"
)

# 保存
data.to_csv("market_data_BTCUSDT_1h.csv", index=False)
EOF
```

---

### 情境 12：我想修改策略參數

```bash
# 方法 1：直接編輯配置文件
nano strategies/multi-timeframe-aggressive.json

# 修改這些參數：
# - stop_loss_atr: 止損距離
# - take_profit_atr: 目標距離
# - position_size: 倉位大小
# - leverage: 槓桿倍數
# - rsi_oversold: RSI 超賣線
# - rsi_overbought: RSI 超買線

# 方法 2：使用 Python 修改
python3 << 'EOF'
import json

# 讀取配置
with open('strategies/multi-timeframe-aggressive.json') as f:
    config = json.load(f)

# 修改參數
config['parameters']['stop_loss_atr'] = 2.0
config['parameters']['take_profit_atr'] = 4.0
config['risk_management']['leverage'] = 3

# 保存
with open('strategies/multi-timeframe-aggressive.json', 'w') as f:
    json.dump(config, f, indent=2, ensure_ascii=False)

print("✅ 配置已更新")
EOF

# 重新回測
python3 backtest_multi_timeframe.py
```

---

### 情境 13：我想查看系統狀態

```bash
# 查看所有結果
python3 快速查看.py

# 查看策略配置
cat strategies/multi-timeframe-aggressive.json | python3 -m json.tool

# 查看系統配置
cat system_config.yaml

# 查看最新回測結果
ls -lt backtest_result_*.json | head -1 | awk '{print $NF}' | xargs cat | python3 -m json.tool

# 查看日誌
tail -100 logs/trading.log
```

---

### 情境 14：我想運行測試

```bash
# 運行所有測試
pytest

# 運行單元測試
pytest tests/unit/

# 運行屬性測試
pytest tests/property/

# 運行集成測試
pytest tests/integration/

# 運行特定測試
pytest tests/integration/test_end_to_end_backtest.py

# 查看測試覆蓋率
pytest --cov=src --cov-report=html
open htmlcov/index.html
```

---

### 情境 15：我想部署策略到生產環境

```bash
# 驗證策略
python3 tools/validate_strategy.py --strategy multi-timeframe-aggressive

# 創建版本
python3 tools/version_strategy.py \
  --strategy multi-timeframe-aggressive \
  --version 1.0.1 \
  --message "優化止損參數"

# 部署
python3 tools/deploy_strategy.py \
  --strategy multi-timeframe-aggressive \
  --environment production

# 啟動實盤
python3 cli.py live --strategy multi-timeframe-aggressive
```

---

## 🐍 Python API 使用

### 回測 API

```python
from src.execution.backtest_engine import BacktestEngine
from src.managers.strategy_manager import StrategyManager
import pandas as pd

# 載入策略
manager = StrategyManager()
strategy = manager.load_strategy("multi-timeframe-aggressive")

# 載入數據
data = pd.read_csv("market_data_BTCUSDT_1h.csv")

# 運行回測
engine = BacktestEngine()
result = engine.run_backtest(
    strategy=strategy,
    data=data,
    initial_capital=1000
)

# 查看結果
print(f"收益: {result.total_pnl_pct:.2f}%")
print(f"勝率: {result.win_rate:.2f}%")
print(f"回撤: {result.max_drawdown_pct:.2f}%")
```

### 優化 API

```python
from src.analysis.optimizer import Optimizer

optimizer = Optimizer()

# 定義參數空間
param_space = {
    'stop_loss_atr': [1.0, 1.5, 2.0],
    'take_profit_atr': [2.0, 3.0, 4.0],
    'rsi_oversold': [20, 25, 30],
    'rsi_overbought': [70, 75, 80]
}

# 網格搜索
results = optimizer.grid_search(
    strategy_id="multi-timeframe-aggressive",
    param_space=param_space,
    data=data
)

print(f"最佳參數: {results['best_params']}")
print(f"最佳收益: {results['best_return']:.2f}%")
```

### 虧損分析 API

```python
from src.analysis.loss_analyzer import LossAnalyzer

analyzer = LossAnalyzer()

# 分析虧損
analysis = analyzer.analyze_losses(trades)

# 查看結果
for reason, pct in analysis['loss_reasons'].items():
    print(f"{reason}: {pct:.1f}%")

for rec in analysis['recommendations']:
    print(f"- {rec}")
```

### 性能監控 API

```python
from src.analysis.performance_monitor import PerformanceMonitor

monitor = PerformanceMonitor()

# 更新指標
monitor.update_metrics(
    strategy_id="multi-timeframe-aggressive",
    trade=trade
)

# 檢查異常
if monitor.check_anomaly("multi-timeframe-aggressive"):
    print("⚠️ 異常檢測！")

# 檢查退化
if monitor.detect_degradation("multi-timeframe-aggressive"):
    print("⚠️ 性能退化！")
```

---

## 🛠️ 工具腳本

### 快速查看工具

```bash
# 查看所有結果
python3 快速查看.py
```

### 數據下載工具

```bash
# 下載市場數據
python3 fetch_market_data.py
```

### Telegram 測試工具

```bash
# 測試 Telegram 連接
python3 test_telegram.py
```

### 策略對比工具

```bash
# 對比不同止損設置
python3 compare_stop_loss.py
```

---

## 📊 輸出文件說明

### 回測結果文件

**格式**：`backtest_result_<strategy>_<timestamp>.json`

**內容**：
- 策略信息
- 時間範圍
- 資金情況
- 交易統計
- 風險指標
- 所有交易明細
- 權益曲線

### 槓桿對比文件

**格式**：`leverage_comparison_<mode>_<atr>.csv`

**內容**：
- 槓桿倍數
- 交易數量
- 勝率
- 收益率
- 最大回撤
- 風險調整收益

### 日誌文件

**位置**：`logs/trading.log`

**內容**：
- 系統啟動/停止
- 交易信號
- 訂單執行
- 錯誤信息
- 風險事件

---

## 🎯 總結

系統共有 **10 大功能模塊**，**5 個可用策略**，支持 **15+ 種使用情境**。

所有功能都已完成並經過測試，可以立即使用！

需要幫助？查看：
- `新手入門教學.md` - 一步步教學
- `PROGRESSIVE_POSITION_STRATEGY.md` - 你的交易策略
- `專案總覽與使用指南.md` - 完整指南
