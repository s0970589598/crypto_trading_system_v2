# 市場數據分析功能說明

## 🎯 功能概述

執行質量評分系統現在整合了完整的市場數據分析功能，可以：
1. 自動載入和更新市場數據
2. 計算多個技術指標
3. 分析進場時的市場環境
4. 基於市場狀態智能評分

---

## 📊 技術指標

### 1. 移動平均線
- **SMA 7/25/99**：短期、中期、長期趨勢
- **EMA 12/26**：指數移動平均線

### 2. MACD
- MACD 線
- 信號線
- 柱狀圖
- 金叉/死叉識別

### 3. RSI（相對強弱指標）
- 14 週期 RSI
- 超買（>70）
- 超賣（<30）

### 4. ATR（平均真實波動幅度）
- 14 週期 ATR
- 波動率百分比

### 5. 布林帶
- 上軌、中軌、下軌
- 價格位置分析

### 6. 成交量分析
- 成交量移動平均
- 成交量比率

---

## 🔍 市場環境分析

### 趨勢分析
- **強上升趨勢**：SMA7 > SMA25 > SMA99
- **上升趨勢**：SMA7 > SMA25
- **震盪**：均線混合
- **下降趨勢**：SMA7 < SMA25
- **強下降趨勢**：SMA7 < SMA25 < SMA99

### RSI 狀態
- **超買**：RSI ≥ 70
- **強勢**：60 ≤ RSI < 70
- **中性**：40 ≤ RSI < 60
- **弱勢**：30 ≤ RSI < 40
- **超賣**：RSI < 30

### MACD 狀態
- **金叉**：MACD 上穿信號線
- **死叉**：MACD 下穿信號線
- **看多**：MACD > 信號線
- **看空**：MACD < 信號線

### 波動率
- **極高**：ATR% > 5%
- **高**：3% < ATR% ≤ 5%
- **正常**：1.5% < ATR% ≤ 3%
- **低**：ATR% ≤ 1.5%

---

## 🤖 智能評分邏輯

### 進場質量評分

#### 1. 趨勢方向檢測
- **逆勢交易**（-25分）：
  - 下降趨勢中做多
  - 上升趨勢中做空
- **震盪市交易**（-10分）：
  - 趨勢不明確時交易

#### 2. RSI 超買超賣檢測
- **RSI 超買時做多**（-20分）
- **RSI 超賣時做空**（-20分）

#### 3. MACD 信號衝突
- **MACD 看空時做多**（-15分）
- **MACD 看多時做空**（-15分）

#### 4. 波動率與槓桿
- **高波動 + 高槓桿**（-15分）：
  - 波動率極高且槓桿 > 20x

#### 5. 布林帶極端位置
- **上軌之上做多**（-10分）
- **下軌之下做空**（-10分）

#### 6. 順勢交易獎勵
- **順勢交易**（+5分）：
  - 上升趨勢做多
  - 下降趨勢做空

---

## 📁 市場數據管理

### 數據文件格式
```
market_data_BTCUSDT_1h.csv
market_data_ETHUSDT_1h.csv
market_data_BTCUSDT_4h.csv
...
```

### 自動更新機制
1. 檢測數據是否過期（超過 24 小時）
2. 自動從 Binance API 獲取新數據
3. 合併並保存更新後的數據
4. 去重並排序

### 支持的時間週期
- 15m（15分鐘）
- 1h（1小時）
- 4h（4小時）
- 1d（1天）

---

## 🚀 使用方法

### 1. 啟動 Web 界面
```bash
./啟動Web界面v2.sh
```

### 2. 進入執行質量評分
- 選擇「6️⃣ 交易覆盤」
- 選擇「執行質量評分」

### 3. 選擇交易
- 使用篩選功能
- 勾選要評分的交易
- 或使用「全選」功能

### 4. 啟用市場分析
- 選擇「自動評分」
- ✅ 勾選「啟用市場數據分析」
- 點擊「執行自動評分」

### 5. 查看結果
- 系統會顯示進度條
- 評分完成後顯示結果
- 註記中包含市場分析信息

---

## 📋 評分記錄格式

```json
{
  "trade_id": "...",
  "entry_score": 85.0,
  "exit_score": 90.0,
  "risk_score": 75.0,
  "discipline_score": 80.0,
  "total_score": 82.5,
  "note": "自動評分（持倉2.5小時，盈虧1.23%）。進場時：uptrend趨勢，RSI=65.3。執行良好，未發現明顯問題。",
  "market_analysis": {
    "trend": "uptrend",
    "rsi": 65.3,
    "macd_state": "bullish",
    "volatility": "normal",
    ...
  }
}
```

---

## ⚠️ 注意事項

### 1. 市場數據要求
- 需要對應交易對的市場數據文件
- 數據時間範圍需要覆蓋交易時間
- 如果數據不足，會跳過市場分析

### 2. 交易對格式
- 系統會自動轉換交易對格式
- 例如：BTC-USDT → BTCUSDT

### 3. 時間匹配
- 系統會找最接近的 K 線數據
- 如果時間差超過 2 個週期，會跳過分析

### 4. API 限制
- 自動更新時會遵守 Binance API 限制
- 每次請求間隔 0.5 秒

---

## 🔧 故障排除

### 問題：市場分析失敗
**原因**：
- 市場數據文件不存在
- 交易對格式不匹配
- 數據時間範圍不足

**解決方案**：
1. 檢查是否有對應的市場數據文件
2. 手動運行 `fetch_market_data.py` 獲取數據
3. 確認數據時間範圍覆蓋交易時間

### 問題：數據更新失敗
**原因**：
- 網絡連接問題
- Binance API 限制
- 時間範圍過大

**解決方案**：
1. 檢查網絡連接
2. 等待幾分鐘後重試
3. 手動更新數據文件

---

## 📈 評分示例

### 示例 1：完美的順勢交易
```
進場：上升趨勢，RSI=55，MACD看多
方向：做多
槓桿：10x
結果：獲利 2.5%

評分：
- 進場質量：105/100（順勢+5分）
- 出場質量：100/100
- 風險管理：100/100
- 紀律遵守：100/100
總分：101.25/100
```

### 示例 2：逆勢交易
```
進場：下降趨勢，RSI=35，MACD看空
方向：做多
槓桿：50x
結果：虧損 -3.2%

評分：
- 進場質量：55/100（逆勢-25分，高槓桿-20分）
- 出場質量：65/100（虧損較大-25分，未止損-10分）
- 風險管理：45/100（高槓桿-30分，虧損大-25分）
- 紀律遵守：70/100（未止損-20分，高槓桿-10分）
總分：58.75/100
```

---

## 💡 使用建議

1. **定期更新數據**：每週運行一次數據更新
2. **批量評分**：使用全選功能批量評分所有交易
3. **分析趨勢**：查看評分趨勢，追蹤改善情況
4. **學習模式**：對比高分和低分交易，學習最佳實踐
5. **調整策略**：根據市場分析結果調整交易策略

---

## 🎓 進階功能

### 自定義指標
可以在 `src/analysis/market_analyzer.py` 中添加自定義指標：
- KDJ
- CCI
- OBV
- 等等

### 多時區分析
可以同時分析多個時間週期：
- 15m：短期趨勢
- 1h：中期趨勢
- 4h：長期趨勢

### 回測驗證
使用歷史數據驗證評分系統的準確性。

---

**祝交易順利！** 🚀
