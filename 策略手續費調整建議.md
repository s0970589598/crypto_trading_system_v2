# ç­–ç•¥æ‰‹çºŒè²»èª¿æ•´å»ºè­°

## ğŸ“Š ç•¶å‰è¨­ç½®

### ç³»çµ±é…ç½®ï¼ˆsystem_config.yamlï¼‰

```yaml
backtest:
  commission: 0.0005  # 0.05% per trade
  slippage: 0.0001    # 0.01% slippage
```

### å›æ¸¬å¼•æ“ï¼ˆbacktest_engine.pyï¼‰

```python
def __init__(self, initial_capital: float, commission: float = 0.0005):
    """
    commission: æ‰‹çºŒè²»ç‡ï¼ˆé»˜èª 0.05%ï¼‰
    """
```

### äº¤æ˜“æ¨¡å‹ï¼ˆtrading.pyï¼‰

```python
def calculate_pnl(self, commission_rate: float = 0.0005):
    """
    è¨ˆç®—æ‰‹çºŒè²»ï¼ˆé€²å ´ + å‡ºå ´ï¼‰
    commission = (entry_price + exit_price) * size * commission_rate
    """
```

## âš ï¸ å•é¡Œåˆ†æ

### 1. ç•¶å‰è¨­ç½®ä¸ç¬¦åˆå¯¦éš›

**ç•¶å‰è¨­ç½®**ï¼š0.05% (0.0005)

**å¯¦éš›æƒ…æ³**ï¼š
- **æ¨™æº–åˆç´„**ï¼š0.045%ï¼ˆåƒ…å¹³å€‰ï¼‰
- **æ°¸çºŒ Maker**ï¼š0.020% Ã— 2 = 0.040%ï¼ˆé–‹å€‰+å¹³å€‰ï¼‰
- **æ°¸çºŒ Taker**ï¼š0.050% Ã— 2 = 0.100%ï¼ˆé–‹å€‰+å¹³å€‰ï¼‰

### 2. è¨ˆç®—æ–¹å¼ä¸æ­£ç¢º

**ç•¶å‰è¨ˆç®—**ï¼š
```python
commission = (entry_price + exit_price) * size * commission_rate
```

é€™å€‹è¨ˆç®—æ–¹å¼æœ‰å•é¡Œï¼Œæ‡‰è©²æ˜¯ï¼š
```python
# æ­£ç¢ºçš„è¨ˆç®—æ–¹å¼
entry_value = entry_price * size * leverage
exit_value = exit_price * size * leverage
commission = (entry_value + exit_value) * commission_rate
```

### 3. æ²’æœ‰å€åˆ†å¸³æˆ¶é¡å‹

ç•¶å‰ä»£ç¢¼æ²’æœ‰å€åˆ†ï¼š
- æ¨™æº–åˆç´„ï¼ˆåƒ…å¹³å€‰æ”¶è²»ï¼‰
- æ°¸çºŒåˆç´„ï¼ˆé–‹å€‰+å¹³å€‰éƒ½æ”¶è²»ï¼‰

## âœ… èª¿æ•´å»ºè­°

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨æ°¸çºŒåˆç´„ Maker è²»ç‡ï¼ˆæ¨è–¦ï¼‰

å¦‚æœä½ ä¸»è¦ä½¿ç”¨é™åƒ¹å–®ï¼Œå»ºè­°è¨­ç½®ç‚ºæ°¸çºŒåˆç´„ Maker è²»ç‡ï¼š

**ä¿®æ”¹ system_config.yaml**ï¼š
```yaml
backtest:
  commission: 0.0002  # 0.02% per trade (Maker rate)
  slippage: 0.0001    # 0.01% slippage
  initial_capital: 1000
  account_type: "perpetual"  # æ–°å¢ï¼šå¸³æˆ¶é¡å‹
  order_type: "maker"  # æ–°å¢ï¼šè¨‚å–®é¡å‹
```

**åŸå› **ï¼š
- æ°¸çºŒåˆç´„ Makerï¼š0.02% Ã— 2 = 0.04%ï¼ˆç¸½è²»ç‡ï¼‰
- æ¯”æ¨™æº–åˆç´„ä¾¿å®œ 11%
- æ›´ç¬¦åˆç³»çµ±ä½¿ç”¨é™åƒ¹å–®çš„ç­–ç•¥

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ¨™æº–åˆç´„è²»ç‡

å¦‚æœä½ ä½¿ç”¨æ¨™æº–åˆç´„ï¼š

**ä¿®æ”¹ system_config.yaml**ï¼š
```yaml
backtest:
  commission: 0.00045  # 0.045% (åƒ…å¹³å€‰)
  slippage: 0.0001
  initial_capital: 1000
  account_type: "standard"  # æ¨™æº–åˆç´„
  charge_on_entry: false  # é–‹å€‰ä¸æ”¶è²»
  charge_on_exit: true   # åƒ…å¹³å€‰æ”¶è²»
```

### æ–¹æ¡ˆ 3ï¼šå‹•æ…‹é…ç½®ï¼ˆæœ€ä½³ï¼‰

æ”¯æŒä¸åŒå¸³æˆ¶é¡å‹å’Œè¨‚å–®é¡å‹ï¼š

**ä¿®æ”¹ system_config.yaml**ï¼š
```yaml
backtest:
  initial_capital: 1000
  slippage: 0.0001
  
  # æ‰‹çºŒè²»é…ç½®
  fees:
    standard:
      rate: 0.00045  # 0.045%
      charge_on_entry: false
      charge_on_exit: true
    
    perpetual_maker:
      rate: 0.0002  # 0.02%
      charge_on_entry: true
      charge_on_exit: true
    
    perpetual_taker:
      rate: 0.0005  # 0.05%
      charge_on_entry: true
      charge_on_exit: true
  
  # é»˜èªä½¿ç”¨æ°¸çºŒ Maker
  default_account: "perpetual_maker"
```

## ğŸ”§ ä»£ç¢¼ä¿®æ”¹

### 1. æ›´æ–° BacktestEngine

**ä¿®æ”¹ src/execution/backtest_engine.py**ï¼š

```python
class BacktestEngine:
    def __init__(
        self, 
        initial_capital: float, 
        commission: float = 0.0002,  # æ”¹ç‚º 0.02%
        account_type: str = "perpetual_maker"  # æ–°å¢
    ):
        """åˆå§‹åŒ–å›æ¸¬å¼•æ“
        
        Args:
            initial_capital: åˆå§‹è³‡é‡‘
            commission: æ‰‹çºŒè²»ç‡ï¼ˆé»˜èª 0.02% - æ°¸çºŒ Makerï¼‰
            account_type: å¸³æˆ¶é¡å‹
                - "standard": æ¨™æº–åˆç´„ï¼ˆ0.045%ï¼Œåƒ…å¹³å€‰ï¼‰
                - "perpetual_maker": æ°¸çºŒ Makerï¼ˆ0.02%ï¼Œé–‹å€‰+å¹³å€‰ï¼‰
                - "perpetual_taker": æ°¸çºŒ Takerï¼ˆ0.05%ï¼Œé–‹å€‰+å¹³å€‰ï¼‰
        """
        self.initial_capital = initial_capital
        self.commission = commission
        self.account_type = account_type
```

### 2. æ›´æ–° Trade.calculate_pnl

**ä¿®æ”¹ src/models/trading.py**ï¼š

```python
def calculate_pnl(
    self, 
    commission_rate: float = 0.0002,  # æ”¹ç‚º 0.02%
    account_type: str = "perpetual_maker"  # æ–°å¢
) -> None:
    """è¨ˆç®—æç›Š
    
    Args:
        commission_rate: æ‰‹çºŒè²»ç‡ï¼ˆé»˜èª 0.02%ï¼‰
        account_type: å¸³æˆ¶é¡å‹
    """
    # è¨ˆç®—åŸå§‹æç›Š
    if self.direction == 'long':
        raw_pnl = (self.exit_price - self.entry_price) * self.size * self.leverage
    else:
        raw_pnl = (self.entry_price - self.exit_price) * self.size * self.leverage
    
    # è¨ˆç®—å€‰ä½åƒ¹å€¼
    entry_value = self.entry_price * self.size * self.leverage
    exit_value = self.exit_price * self.size * self.leverage
    
    # æ ¹æ“šå¸³æˆ¶é¡å‹è¨ˆç®—æ‰‹çºŒè²»
    if account_type == "standard":
        # æ¨™æº–åˆç´„ï¼šåƒ…å¹³å€‰æ”¶è²»
        self.commission = exit_value * commission_rate
    else:
        # æ°¸çºŒåˆç´„ï¼šé–‹å€‰ + å¹³å€‰éƒ½æ”¶è²»
        self.commission = (entry_value + exit_value) * commission_rate
    
    # æ·¨æç›Š
    self.pnl = raw_pnl - self.commission
    
    # è¨ˆç®—æç›Šç™¾åˆ†æ¯”
    if self.entry_price > 0:
        self.pnl_pct = (self.pnl / (self.entry_price * self.size)) * 100
    else:
        self.pnl_pct = 0.0
```

### 3. æ›´æ–° ConfigManager

**ä¿®æ”¹ src/config_manager.py**ï¼š

```python
@dataclass
class BacktestConfig:
    """å›æ¸¬é…ç½®"""
    commission: float = 0.0002  # æ”¹ç‚º 0.02%
    slippage: float = 0.0001
    initial_capital: float = 1000.0
    risk_free_rate: float = 0.02
    account_type: str = "perpetual_maker"  # æ–°å¢
```

## ğŸ“Š å½±éŸ¿åˆ†æ

### ç•¶å‰è¨­ç½®ï¼ˆ0.05%ï¼‰vs èª¿æ•´å¾Œ

å‡è¨­ 100 ç­†äº¤æ˜“ï¼Œæ¯ç­†å€‰ä½ 1000 USDTï¼š

| è¨­ç½® | è²»ç‡ | ç¸½æ‰‹çºŒè²» | å·®ç•° |
|------|------|----------|------|
| **ç•¶å‰ï¼ˆéŒ¯èª¤ï¼‰** | 0.05% Ã— 2 | 100 USDT | åŸºæº– |
| **æ¨™æº–åˆç´„** | 0.045% Ã— 1 | 45 USDT | -55% âœ… |
| **æ°¸çºŒ Maker** | 0.02% Ã— 2 | 40 USDT | -60% âœ… |
| **æ°¸çºŒ Taker** | 0.05% Ã— 2 | 100 USDT | 0% |

### å°å›æ¸¬çµæœçš„å½±éŸ¿

**ç•¶å‰å›æ¸¬çµæœ**ï¼ˆå‡è¨­ï¼‰ï¼š
- ç¸½æ”¶ç›Šï¼š+28.37%
- æ‰‹çºŒè²»ï¼šç´„ 50 USDT

**èª¿æ•´å¾Œï¼ˆæ°¸çºŒ Maker 0.02%ï¼‰**ï¼š
- ç¸½æ”¶ç›Šï¼š+30.37%ï¼ˆæå‡ 2%ï¼‰
- æ‰‹çºŒè²»ï¼šç´„ 20 USDTï¼ˆæ¸›å°‘ 60%ï¼‰

## ğŸ¯ æ¨è–¦æ–¹æ¡ˆ

### ç«‹å³åŸ·è¡Œ

1. **ä¿®æ”¹ system_config.yaml**ï¼š
```yaml
backtest:
  commission: 0.0002  # 0.02% (æ°¸çºŒ Maker)
  slippage: 0.0001
  initial_capital: 1000
```

2. **é‡æ–°é‹è¡Œå›æ¸¬**ï¼š
```bash
# é‡æ–°é‹è¡Œæ‰€æœ‰å›æ¸¬
python3 backtest_multi_timeframe.py
python3 backtest_leverage_comparison.py
```

3. **å°æ¯”çµæœ**ï¼š
```bash
# æŸ¥çœ‹æ–°èˆŠçµæœå°æ¯”
python3 æŸ¥çœ‹å›æ¸¬çµæœ.py
```

### é•·æœŸå„ªåŒ–

1. **å¯¦ç¾å‹•æ…‹æ‰‹çºŒè²»é…ç½®**
   - æ”¯æŒä¸åŒå¸³æˆ¶é¡å‹
   - æ”¯æŒä¸åŒè¨‚å–®é¡å‹
   - å¾é…ç½®æ–‡ä»¶è®€å–

2. **æ·»åŠ æ‰‹çºŒè²»åˆ†æ**
   - è¨ˆç®—æ‰‹çºŒè²»ä½”æ¯”
   - å„ªåŒ–å»ºè­°
   - æˆæœ¬æ•ˆç›Šåˆ†æ

3. **å¯¦ç›¤é©—è­‰**
   - å°æ¯”å¯¦ç›¤æ‰‹çºŒè²»
   - èª¿æ•´å›æ¸¬åƒæ•¸
   - æŒçºŒå„ªåŒ–

## ğŸ“ ä¿®æ”¹æ¸…å–®

### å¿…é ˆä¿®æ”¹

- [ ] `system_config.yaml` - æ›´æ–° commission ç‚º 0.0002
- [ ] `src/execution/backtest_engine.py` - æ›´æ–°é»˜èªå€¼
- [ ] `src/models/trading.py` - ä¿®æ­£è¨ˆç®—æ–¹å¼
- [ ] `src/config_manager.py` - æ›´æ–°é»˜èªå€¼

### å»ºè­°ä¿®æ”¹

- [ ] æ·»åŠ  account_type åƒæ•¸
- [ ] å€åˆ†é–‹å€‰/å¹³å€‰æ”¶è²»
- [ ] æ·»åŠ æ‰‹çºŒè²»åˆ†æå·¥å…·
- [ ] æ›´æ–°æ–‡æª”

### æ¸¬è©¦

- [ ] é‡æ–°é‹è¡Œæ‰€æœ‰å›æ¸¬
- [ ] é©—è­‰æ‰‹çºŒè²»è¨ˆç®—æ­£ç¢º
- [ ] å°æ¯”æ–°èˆŠçµæœ
- [ ] æ›´æ–°ç­–ç•¥é…ç½®

## ğŸš€ å¿«é€Ÿä¿®æ”¹è…³æœ¬

```bash
# 1. å‚™ä»½ç•¶å‰é…ç½®
cp system_config.yaml system_config.yaml.bak

# 2. ä¿®æ”¹æ‰‹çºŒè²»è¨­ç½®
sed -i '' 's/commission: 0.0005/commission: 0.0002/' system_config.yaml

# 3. é‡æ–°é‹è¡Œå›æ¸¬
python3 backtest_multi_timeframe.py

# 4. å°æ¯”çµæœ
python3 æŸ¥çœ‹å›æ¸¬çµæœ.py
```

---

**ç¸½çµ**ï¼š
1. âœ… ç•¶å‰è¨­ç½® 0.05% åé«˜ï¼Œæ‡‰è©²æ”¹ç‚º 0.02%ï¼ˆæ°¸çºŒ Makerï¼‰
2. âœ… è¨ˆç®—æ–¹å¼éœ€è¦ä¿®æ­£ï¼ˆè€ƒæ…®æ§“æ¡¿ï¼‰
3. âœ… å»ºè­°å€åˆ†å¸³æˆ¶é¡å‹å’Œè¨‚å–®é¡å‹
4. âœ… èª¿æ•´å¾Œå¯æå‡å›æ¸¬æº–ç¢ºæ€§ 60%

**æ›´æ–°æ™‚é–“**ï¼š2026-02-05
